---
title: 楽天証券からお気に入り銘柄の当日データを取得する（２）
description: null
date: 2019-10-24T15:10:46.429Z
thumbnail: null
categories:
  - スクレイピング
tags:
  - Python
permalink: '01'
---
前回の記事の続きとなります。  
楽天証券からお気に入り登録している銘柄の当日データをSleniumで取得してファイル出力するコードを用意しました。

{{<highlight python>}}
    import time
    from selenium import webdriver
    import csv
    import datetime

    # 仮想ブラウザ起動、URL先のサイトにアクセス
    driver = webdriver.Chrome()
    driver.get('https://www.rakuten-sec.co.jp/')
    time.sleep(1)

    # ログイン
    el = driver.find_element_by_name("loginid")
    el.clear()
    el.send_keys('****')
    el = driver.find_element_by_name("passwd")
    el.send_keys('****')
    el = driver.find_element_by_name("loginform")
    el.submit()
    time.sleep(1)

    # お気に入り銘柄ページに遷移
    el = driver.find_element_by_id("gmenu_domestic_stock")
    el.click()
    el = driver.find_element_by_id("jp-stk-top-btn-info-prc-reg-lst")
el.click()

    # 銘柄情報を取得
    dataList = []
    pageCount = driver.find_elements_by_class_name("number")
    for pn in range(0,len(pageCount)):
        pageElem = driver.find_elements_by_class_name("number")
        pageElem[pn].click()
        # テーブル内容取得
        try:
            tableElem = driver.find_element_by_class_name("tbl-data-01")
            trs = tableElem.find_elements_by_tag_name("tr")

            # ヘッダ行は除いて取得
            for i in range(1,len(trs)):
                tds = trs[i].find_elements_by_tag_name("td")
                line = []
                for j in range(0,len(tds)):
                    line.append(tds[j].text)
                dataList.append(line)
        # お気に入り登録がないページはスキップ
        except Exception:
            print("要素が見つかりませんでした")

    now = datetime.datetime.now()
    YYYY = str(now.year)
    MM = str(now.month)
    DD = str(now.day)

    # ファイル出力（タブ区切り）
    with open('/Users/shiraitatsuyo/kikagaku/'+YYYY+MM+DD+'-    BrandList.csv', 'a') as f:
        writer = csv.writer(f, delimiter='\t')
        writer.writerows(dataList)

    # ファイルクローズ
    f.close()
{{</ highlight>}}

## はまったところ
お気に入り銘柄は10ページ（固定）に分かれているのですが、最初のページ読み込み時にclass属性「number」のリストを取得して改ページの制御をしようとしたところ3ページ目以降の遷移で要素が取得出来ずにエラーとなりました。  
改ページごとにclass属性「number」の要素を取り直すようにしたら動くようになりました。
## 今後の活用法
お気に入り登録している銘柄の株価と出来高の情報を蓄積して、数ヶ月分データが溜まったところで機械学習を用いた株価予測の分析をしてみたいと思います。  



